<script>
    let locationData = {};

    // Fetch location data from backend when the page loads
    window.onload = async () => {
        try {
            const response = await fetch('https://aqi-reflex-agent.onrender.com/locations');
            locationData = await response.json();
            
            const stateSelect = document.getElementById('state-list');
            stateSelect.innerHTML = Object.keys(locationData)
                .map(state => `<option value="${state}">${state}</option>`)
                .join('');
            
            updateCounties(); // Load counties for the first state automatically
        } catch (err) {
            console.error("Failed to load locations:", err);
        }
    };

    // Update the County dropdown based on selected State
    function updateCounties() {
        const state = document.getElementById('state-list').value;
        const countySelect = document.getElementById('county-list');
        
        if (locationData[state]) {
            countySelect.innerHTML = locationData[state]
                .map(county => `<option value="${county}">${county}</option>`)
                .join('');
        }
    }

    async function getPrediction() {
        const btn = document.getElementById('btn-text');
        const resultArea = document.getElementById('result-area');
        
        const payload = {
            state: document.getElementById('state-list').value,
            county: document.getElementById('county-list').value,
            pm25: document.getElementById('pm25').value,
            temp: document.getElementById('temp').value,
            humidity: document.getElementById('hum').value,
            wind: document.getElementById('wind').value
        };

        if (!payload.pm25 || !payload.temp || !payload.state || !payload.county) {
            alert("Please fill in all location and weather data.");
            return;
        }

        btn.innerHTML = '<div class="loading-spinner"></div> Processing...';
        btn.disabled = true;

        try {
            const response = await fetch('https://aqi-reflex-agent.onrender.com/predict', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            const data = await response.json();

            if (data.success) {
                resultArea.classList.remove('hidden');
                resultArea.style.backgroundColor = data.category.color;
                document.getElementById('aqi-val').innerText = data.prediction;
                document.getElementById('aqi-label').innerText = data.category.label;
                resultArea.scrollIntoView({ behavior: 'smooth' });
            } else {
                alert("Error: " + data.error);
            }
        } catch (err) {
            alert("Backend not reachable. Ensure app.py is running!");
        } finally {
            btn.innerHTML = '<span>Run Forecast</span>';
            btn.disabled = false;
        }
    }
</script>
